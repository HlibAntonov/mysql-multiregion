type: update
name: Multiregion Database Cluster Recovery
id: multiregion-db-recovery
description:
  text: The Database Cluster Recovery add-on performs a comprehensive diagnostic of your Multiregion DB Cluster to detect any disruptions of the provisioned service. In case of errors, the automatic Cluster Recovery functionality can restore the cluster operability after most of the problems.
  short: The add-on performs a comprehensive diagnostic of your database cluster and can perform automatic recovery.
logo: https://raw.githubusercontent.com/jelastic-jps/mysql-cluster/master/addons/recovery/images/database-recovery.png

baseUrl: https://raw.githubusercontent.com/sych74/mysql-multiregion/master/addons/db-recovery

targetNodes:
  nodeGroup: 
    - sqldb

globals:
  multiregional_utils: https://github.com/jelastic-jps/common/blob/main/multiregional-cluster-utils

onInstall:
  - script: ${globals.multiregional_utils}/get-cluster-envs.js
    envName: ${env.envName}
  - setGlobals:
      DBEnvs: ${response.items.join(,)}
  - script: |
      var envs = '${globals.DBEnvs}'.split(','), actions = [];
      for (var i = 0, n = envs.length; i < n; i ++) {
        actions.push({
          jps: "/addon2.yml?_r=${fn.random}",
          envName: envs[i]
        });
      }
      return { result: 0, onAfterReturn: { install: actions } };
